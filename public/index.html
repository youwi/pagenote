
<!--这里是主页架子-->
<meta charset="UTF-8">

<link href="css/bootstrap.min.css" rel="stylesheet">

<link href="css/messenger-spinner.css" rel="stylesheet">
<link href="css/messenger-theme-flat.css" rel="stylesheet">
<link href="css/messenger.css" rel="stylesheet">

<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="ckeditor/ckeditor.js"></script>

<script src="js/messenger.min.js"></script>
<script src="js/messenger-theme-flat.js"></script>


<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Modal title</h4>
            </div>
            <div class="modal-body">
                <div class=" ">
                    <div class="input-group">
                        <span class="input-group-addon" id="basic-addon1">文件名</span>
                        <input id="thfilename" type="text" class="form-control" placeholder="qwer/abc.html" aria-describedby="basic-addon1">
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="newfile">立即新建文件</button>
            </div>
        </div>
    </div>
</div>





<div class="navbar navbar-inverse navbar-fixed-top navbar-layoutit  navfix">
    <div class="navbar-header navfix">
        <button data-target="navbar-collapse" data-toggle="collapse" class="navbar-toggle" type="button">
            <span class="glyphicon-bar"></span>
            <span class="glyphicon-bar"></span>
            <span class="glyphicon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">主页<!--<span class="label label-default">.....</span>--></a>
    </div>
    <div class="collapse navbar-collapse navfix">

<!--
        <ul class="nav pull-right navfix">
            <li>
                <div class="btn-group">
                    <a class="btn btn-xs btn-info" href="#">关于我们</a>
                </div>


                <div class="btn-group" data-toggle="buttons-radio">
                    <button href="template/feedback.html" role="button" data-toggle="modal" data-target="#feedbackModal" id="feedback" class="btn btn-xs btn-primary">
                        <i class="glyphicon-comment glyphicon"></i> 问题反馈</button>
                </div>
            </li>
        </ul>-->
        <label id="d_filename" class="nav "></label>
        <ul class="nav navfix  pull-right" id="menu-layoutit">
            <li>
                <div class="btn-group patch-blc" data-toggle="buttons-radio">
                    <button type="button" id="edit" class=" btn btn-xs btn-primary">
                        <!--<i class="glyphicon glyphicon-edit "></i>-->
                        编辑</button>
                    <button type="button" class="btn btn-xs btn-primary" id="save">
                        <!--<i class="glyphicon-eye-close glyphicon"></i>-->
                        保存</button>
                    <button type="button" class="btn btn-xs btn-primary" data-toggle="modal" data-target="#myModal">
                        <!--<i class="glyphicon-eye-open glyphicon"></i> -->
                        新建</button>
                <!--</div>-->
                <!--<div class="btn-group">-->
                    <!--<button type="button" class="btn btn-xs btn-primary" id="runcurr" data-target="#downloadModal" href="template/download.html" role="button" data-toggle="modal">-->
                        <!--&lt;!&ndash;<i class="glyphicon-chevron-down glyphicon"></i>&ndash;&gt;-->
                        <!--运行</button>-->
                    <!--<button class="btn btn-xs btn-primary" id="button-share-modal" href="template/saveLayout.html" role="button" data-toggle="modal" data-target="#shareModal">-->
                        <!--&lt;!&ndash;<i class="glyphicon-share glyphicon"></i>&ndash;&gt;-->
                        <!--保存</button>-->
                  <!--  <button class="btn btn-xs btn-primary" href="#clear" id="clear"><i class="glyphicon-trash glyphicon"></i> 删除</button>
-->
                </div>
 <!--               <div class="input-group input-group-sm col-xs-3">
                    <span class="input-group-addon" id="sizing-addon3">@</span>
                    <input type="text" class="form-control" placeholder="url" aria-describedby="sizing-addon3">
                </div>-->

            </li>
        </ul>
    </div><!--/.navbar-collapse -->
</div>


<div class="sidebar-nav">

    <ul class="nav nav-list accordion-group">
        <li class="nav-header" id="d_copp">
            <!--<i class="glyphicon-plus glyphicon"></i>文件列表-->
            <!--<i class="glyphicon-plus glyphicon"></i>-->
            <!--<input id="d_rootname">-->
            <!--<div class="pull-right popover-info"><i class="glyphicon glyphicon-question-sign"></i>-->
                <!--<div class="popover fade right"><div class="arrow"></div>-->
                    <!--<h3 class="popover-title">提示：</h3>-->
                    <!--<div class="popover-content">文件列表制作中</div></div>-->
            <!--</div>-->
            <!--/root-->
            /root
            <i class="glyphicon glyphicon-resize-horizontal pull-right" id=" "></i>
        </li>
        <ul id="treeroot"></ul>
    </ul>

</div>


<script>
    $.fn.extend({
        treed: function (o) {

            var openedClass = 'glyphicon-minus-sign';
            var closedClass = 'glyphicon-plus-sign';

            if (typeof o != 'undefined') {
                if (typeof o.openedClass != 'undefined') {
                    openedClass = o.openedClass;
                }
                if (typeof o.closedClass != 'undefined') {
                    closedClass = o.closedClass;
                }
            }
            ;

//initialize each of the top levels
            var tree = $(this);
            tree.addClass("tree");
            tree.find('li').has("ul").each(function () {
                var branch = $(this); //li with children ul
                branch.prepend("<i class='indicator glyphicon " + closedClass + "'></i>");
                branch.addClass('branch');
                branch.on('click', function (e) {
                    if (this == e.target) {
                        var icon = $(this).children('i:first');
                        icon.toggleClass(openedClass + " " + closedClass);
                        $(this).children().children().toggle();
                    }
                    // console.log("click++")
                })
                branch.children().children().toggle();
            });
//fire event from the dynamically added icon
            tree.find('.branch .indicator').each(function () {
                $(this).on('click', function () {
                    $(this).closest('li').click();
                    //  console.log("click++")
                });
            });
//fire event to open branch if the li contains an anchor instead of text
//    tree.find('.branch>a').each(function () {
//        $(this).on('click', function (e) {
//            $(this).closest('li').click();
//            e.preventDefault();
//           // console.log("click++")
//        });
//    });
//fire event to open branch if the li contains a button instead of text
            tree.find('.branch>button').each(function () {
                $(this).on('click', function (e) {
                    $(this).closest('li').click();
                    e.preventDefault();
                    // console.log("click++")
                });
            });
        }
    });

</script>
<script>

    var cogg;
    $("#d_copp").click(function(){
        if(cogg==null){
            $(".sidebar-nav").width("350px");
            cogg=true;
        }
        else{
            $(".sidebar-nav").width("190px");
            cogg=null
        }
        return false;
    });


    $("#tagop").click(function () {
        $("#tagedit").slideToggle("slow");
    });
    $("#tagtask").click(function () {
    });

    $("#save").click(save=function () {
        // var filename = $('#WikiContent').data("file");
        $.ajax({
            url: '/wikiSave',
            data:{ filename: currfile,  wikiContent: CK?CK.getData():$("#WikiContent").html()},
            method:"POST",
            success:function (data) {
                $.globalMessenger().post({
                    message: data,
                    hideAfter:1,
                    type: 'error',
                    showCloseButton: true
                })
            },
            error:function(err){
                $.globalMessenger().post({
                    message: err.status,
                    hideAfter:1,
                    type: 'error',
                    showCloseButton: true
                })
                console.log("出错");
            },
        });
    });
    $("#upload").click(function () {
        //$.globalMessenger().post("#upload");
        $("#uppc")[0].click();
        upac();
    });
    $("#newfile").click(function(){
        $.post('/wikiAdd', {
            filename:thfilename.value,
        },function(data){
            $.globalMessenger().post({
                message: data,
                hideAfter:1,
                type: 'error',
                showCloseButton: true
            });
            $("#myModal").hide();
            refreshTree();
            //window.location.href = "/"+thfilename.value
        });
    });
    $("#runcurr").click(function () {
        // var filename = $('#WikiContent').data("file");

        $.ajax({
            url: '/caseRun',
            data:{ filename: currfile},
            method:"POST",
            success:suc=function(data){
                var json;
                try{
                    json= JSON.parse(data)
                }catch(e){
                    json={"转换为:":data};
                    console.log("转换出错");
                }
                editor_out_json.set(json);
                editor_out_raw.set(data);
                $('#tabs-154688 li:eq(4) a').tab('show');
                $.globalMessenger().post({
                    message: 'ok',
                    hideAfter:1,
                    type: 'error',
                    showCloseButton: true
                });
            },
            error:function(err){
                if(err.status==200){
                    suc(err.responseText)

                }
                $('#tabs-154688 li:eq(3) a').tab('show');
                console.log("出错");
                $.globalMessenger().post({
                    message: err.status,
                    hideAfter:1,
                    type: 'error',
                    showCloseButton: true
                });
            }
        });
    });
    var CK;
    $("#edit").click(function(){
        console.log("其实可以进入编辑态 document.designMode = 'on' 之后就可以粘贴doc;");
        if(CK==null)
        {
            CK=CKEDITOR.replace('WikiContent');
            //CK.setData(window.frames.if.document.body.innerHTML) //设置内容

            CKEDITOR.on('instanceReady', function (e) {
                //  var td = document.getElementById('cke_contents_' + e.editor.name), tbody = td.parentNode.parentNode;
                // td.style.height = h - tbody.rows[0].offsetHeight - tbody.rows[2].offsetHeight + 'px';
                //$('.cke_contents').css('height', "calc(100% - 210px)");
                $('.cke_contents').css('height', "calc(100% - 120px)");


             //   frames[0].addEventListener('paste',doparst);//设置可粘贴
                //setTimeout("$('.cke_contents').css('height', $('body').height()-200);",100) ;//设置一个超时对象:自动变高
            });
        }else{
            $("#WikiContent")[0].innerHTML=CK.getData();
            CK.destroy();
            CK=null;
        }
    });
    function refreshTree(){
        $('#treeroot').empty();
        $.getJSON("/wikiList?root="+$("myroot").val(),function(json){

            var domtree="<li>root\n";
            domtree= buildTree(json);
            domtree +="</li>";
            tmp2=domtree;
            $("#treeroot").append(domtree);
            $('#treeroot').treed();


            $("#treeroot a").click(function(){
               // currfile=$(this)[0].href; //中文会转义
                currfile=$(this).attr("href");
                $("#d_filename").text(currfile);
                $.ajax({
                    url: currfile,
                    method:"GET",
                    success:suc=function(data){
                        $("#WikiContent").html(data);
                        if(CK)   CK.destroy();
                        CK=null;
                      //  $("#cke_WikiContent").remove();
                    },
                    error:function(err){
                        //如果是js文件加载执行以后
                        //readyState: 4, responseText: "{"a":"aaaa"↵}", status: 200, statusText: "OK"}
                        if(err.status==200){
                            suc(err.responseText)
                            //editor_text.set(JSON.parse(err.responseText));
                            //editor_tree.set(JSON.parse(err.responseText));
                            //ace_editor.setValue(err.responseText);
                        }
                        console.log("出错");
                    }
                });


                //
                //$.get(currfile, function (data) {
                //
                //    editor_text.set(cc);
                //    editor_tree.set(cc);
                //    ace_editor.setValue(data);
                //    //$.globalMessenger().post(data);
                //});

                return false;
            });

            $(".branch span").click(function() {
                //$(this).prev().toggleClass("glyphicon-minus-sign" + " " + "glyphicon-plus-sign");
                $(this).parent().children().children().toggle();
                currfile = $(this).attr("data-link");
                $("#d_filename").text(currfile);
                $.ajax({
                    url: currfile,
                    method: "GET",
                    success: suc = function (data) {
                        $("#WikiContent").html(data);
                        if (CK)   CK.destroy();
                        CK = null;
                    },
                    error: function (err) {

                        if (err.status == 200) {
                            suc(err.responseText)

                        }
                        console.log("出错");
                    }
                });
            });
            //
//        $("#treeroot a").each(function(){
//
////        $(this)[0].oncontextmen=function(){
////            return false;
////        };
//            $(this).mousedown(function(e){
//                var key = e.which; // 鼠标键位（右键3，左键1，滚轮2）
//                if(key == 3){
//                    var x = e.clientX;
//                    var y = e.clientY;
//                    $(".text").html("X: "+x+" Y: "+y);
//                    $(".desk").show().css({left:x,top:y});
//                }
//                if(key == 1){
//                    var x = e.clientX;
//                    var y = e.clientY;
//                    $(".text").html("X: "+x+" Y: "+y);
//                    $(".desk").show().css({left:x,top:y});
//                    if (e.preventDefault) {
//                        e.preventDefault();
//                    } else {
//                        e.returnValue = false;
//                    }
//                    e.stopPropagation();
//                    console.log("ab");
//                  //  return false;
//
//                }
//
//            })
//
//        });
        });
    }
    function buildTree(node,dir){
        //domtree+="<li>root";
        var domtree="";
        dir=dir||"";
        for(child in node){
            if(child!="filename")
            {
                domtree+="<li>"+"<span data-link='"+dir+"/"+child+"/index.html'>"+child+"</span>";
                domtree+=buildTree(node[child],dir+"/"+child);
                domtree+="</li>\n";
            }else{
                domtree+="<ul>"
                for(var i=0;i< node[child].length;i++)
                    domtree+="\t\t<li><a href='"+dir+"/"+node[child][i]+"'>"+node[child][i]+"</a></li>\n";
            }
        }
        domtree+="</ul>\n";

        return domtree||"";

    }

    function doparst(e){

        var reader = new FileReader();
        var tout;

        if(e.clipboardData.types.indexOf('Files') > -1)
        {
            console.log("data:" + e.clipboardData);
            console.log("types:"+ e.clipboardData.types);
            console.log("getData:"+ e.clipboardData.getData("img/*"));
            //console.log("files[0]:"+ e.clipboardData.files[0]);
            console.log("items[0]:"+ e.clipboardData.items[0]);

            var it=e.clipboardData.items[0];
            //	console.log("items[0].getData():"+ it.getData());
            reader.readAsDataURL( it.getAsFile());
            console.log("tout:",tout);
            console.log("reader",reader);
            console.log("text:"+reader.result.toString());//为结果文件
            xio=reader; //注意读取有时间限制!! 要使用onload来读取结果
            e.clipboardData.setData("text/plain", '<img src="' + reader.result +'" >');
            console.log(e.srcElement);
            reader.onload=function(ev){
                console.log("<img src=\"" + reader.result+"\" >");
                $(e.srcElement).append(  "<img src=\"" + reader.result+"\" >" )  ;
            };
            e.preventDefault();
            console.log(e);
            //  	'<img src="' + reader.result +'" >';//生成图片,然后把图片加入就好了.
        }

    };
    document.onkeydown = function (event) {
        var e = event || window.event;
        var keyCode = e.keyCode || e.which;
        if (e.ctrlKey && (keyCode == 83 )) { // CTRL +S
            // console.log("保存");     // $("#f").submit();    //  save();
            $("#save").trigger("click");
            e.returnValue = false;
        }else if(e.ctrlKey && (keyCode == 82 )){ // CTRL+R
            $("#runcurr").trigger("click");
            e.returnValue = false;
        }
    };

    $(document).ready( function () {
        refreshTree();

    });
    $._messengerDefaults = {
        extraClasses: 'messenger-fixed messenger-on-bottom messenger-on-left',
        theme: 'flat',
        hideAfter: 1
    };



</script>


<style>
    .tree, .tree ul {
        margin:0;
        padding:0;
        list-style:none
    }
    .tree ul {
        margin-left:1em;
        position:relative
    }
    .tree ul ul {
        margin-left:.5em
    }
    .tree ul:before {
        content:"";
        display:block;
        width:0;
        position:absolute;
        top:0;
        bottom:0;
        left:0;
        border-left:1px solid
    }
    .tree li {
        margin:0;
        padding:0 1em;
        /*line-height:2em;*/
        color:#369;
        font-weight:700;
        position:relative
    }
    .tree ul li:before {
        content:"";
        display:block;
        width:10px;
        height:0;
        border-top:1px solid;
       /* margin-top:-1px;*/
        position:absolute;
        top:1em;
        left:0
    }
    .tree ul li:last-child:before {
        background:#FFF;
        height:auto;
        top:1em;
        bottom:0
    }
    .indicator {
        margin-right:5px;
    }
    .tree li a {
        text-decoration: none;
        color:#369;
        white-space: nowrap;
        overflow: hidden;
    }
    .tree li button, .tree li button:active, .tree li button:focus {
        text-decoration: none;
        color:#369;
        border:none;
        background:transparent;
        margin:0px 0px 0px 0px;
        padding:0px 0px 0px 0px;
        outline: 0;
    }
    </style>

<div id="WikiContent">

</div>


<style>
    .cke_button__green_label{
        display: inline;
        padding: 0px 10px;
        color: rgb(255, 255, 255);
        border-radius: 10px;
        background-color: rgb(78, 200, 59);
    }
    .cke_button__green_icon{
        display: none;
        padding: 0px 10px;
        color: rgb(255, 255, 255);
        border-radius: 10px;
        background-color: rgb(78, 200, 59);
    }
    .cke_button__blue_label{
        display: inline;
        padding: 0px 10px;
        color: rgb(255, 255, 255);
        border-radius: 10px;
        background-color: rgb(115, 51, 241);
    }
    .cke_button__blue_icon {
        display: none;
        padding: 0px 10px;
        color: rgb(255, 255, 255);
        border-radius: 10px;
        background-color: rgb(115, 51, 241);
    }

    .tree li a:hover{
        background: #000;
        box-shadow: 1px 1px 5px 5px rgb(73, 73, 239);
        //-webkit-gradient(linear, left top, left bottom, from(#00abeb), to(#fff), color-stop(0.5, #fff), color-stop(0.5, #66cc00));
        color:#FFF;
    }
    .branch span:hover{
        cursor:pointer;
        background: #000;
        box-shadow: 1px 1px 5px 5px rgb(73, 73, 239);
    //-webkit-gradient(linear, left top, left bottom, from(#00abeb), to(#fff), color-stop(0.5, #fff), color-stop(0.5, #66cc00));
        color:#FFF;
    }
    .patch-blc button{
        background-color: #222222 !important;
        border-color: #222222!important;
        height: 22px;
    }

    #d_copp{
        background: #222222;
        color: white;
    }
    body{
        line-height: 1
    }

    .jsoneditor div.tree button {
        height: 18px;

    }
    .container-fluid:after{
        content:none !important;
        color: #0f0f0f;
    }

    .tree ul li:before {
        margin-top: -6px;
    }

    pre {
        margin-bottom: 0px;
        padding-top: 0px;
        padding-bottom: 0px;
        padding-left: 0px;
        padding-right: 0px;
    }
    .jsoneditor .field.highlight, .jsoneditor .field[contenteditable=true]:focus, .jsoneditor .field[contenteditable=true]:hover, .jsoneditor .value.highlight, .jsoneditor .value[contenteditable=true]:focus, .jsoneditor .value[contenteditable=true]:hover {
        background-color: rgba(192, 192, 86, 0.38);
        border: 1px solid rgba(218, 218, 132, 0.35);
        border-radius: 2px;
    }

    .jsoneditor .separator {
        padding: 0px 0;
    }

    /*修正上下高度
    */
    .jsoneditor .field, .jsoneditor .readonly, .jsoneditor .value {
        border: 1px solid transparent;
        min-height: 12px;
        min-width: 32px;
        padding: 0px;
        margin: 0px;
        word-wrap: break-word;
        float: left;
    }

    .height100{
        height: calc(100% - 0px);
    }

    .input-group[class*=col-] {
        float: right;
    }
    #d_filename{
        color: wheat;
    }

    #filelist{
        width: 125px;
        float: left;
        padding: 15px 0 15px 15px;
        height: 100%;
    }
    .sidebar-nav {
        position: fixed;
        width: 190px;
        left: 0px;
        bottom: 0;
        top: 24px;
        background: #FFF;
        /* padding: 10px 15px;*/
        z-index: 10;
        -webkit-transition: all 500ms ease;
        -moz-transition: all 500ms ease;
        -ms-transition: all 500ms ease;
        -o-transition: all 500ms ease;
        transition: all 500ms ease;
    }


    .nav>li>a {
        /*
           修正tab标签页的边距
        */
        position: relative;
        display: block;
        padding: 1px 5px;
    }
    .navfix{
        /*
            修正导航条的高度
        */
        height:24px !important;
    }
    .navbar-layoutit {
        min-height: 32px;
        padding: 5px;
        height:33px;
    }
    #d_filename{
        padding-top: 5px;
    }

    .navbar-brand {
        float: left;
        height: 24px;
    }
    .navbar {
    // position: relative;
    //min-height: 24px;
        margin-bottom: 0px;
        -moz-box-shadow:0px 2px 5px #333333; -webkit-box-shadow:0px 2px 5px #333333; box-shadow:0px 2px 5px #333333;
    }
    .navbar-layoutit {
        min-height: 24px;
        padding: 0px;
        height: 24px;
    }
    .outfix{
        float:right !important;
    }
    .nav-tabs>li.active>a, .nav-tabs>li.active>a:focus, .nav-tabs>li.active>a:hover {
        color: #555;
        cursor: default;
        background-color: #D5DDF6;
    }

    .jsoneditor{
        border-top-width: 0px;
    }
    body {
        /*
        修正导航条和35像素和 滚动条
        */
        height: calc(100% - 24px);
        padding-top: 26px;
        padding-bottom: 1px;
        margin-left: 200px;
        -webkit-transition: margin 500ms ease;
        -moz-transition: margin 500ms ease;
        -ms-transition: margin 500ms ease;
        -o-transition: margin 500ms ease;
        transition: margin 500ms ease;
    }

    .navbar-layoutit .navbar-brand {
        width: 180px;
        color: #fff;
        padding: 0;
        margin: 0 5px;
    }

    .navbar-layoutit .navbar-brand .label {
        position: relative;
        left: 10px;
        top: -3px;
        font-weight: normal;
        font-size: 9px;
        background: #666;
        -webkit-box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.7);
        -moz-box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.7);
        box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.7);
    }


    .tree, .tree ul {
        margin:0;
        padding:0;
        list-style:none
    }
    .tree ul {
        margin-left:1em;
        position:relative
    }
    .tree ul ul {
        margin-left:.5em
    }
    .tree ul:before {
        content:"";
        display:block;
        width:0;
        position:absolute;
        top:0;
        bottom:0;
        left:0;
        border-left:1px solid
    }
    .tree li {
        margin:0;
        padding:0 1em;
        /*line-height:2em;*/
        color:#369;
        font-weight:700;
        position:relative
    }
    .tree ul li:before {
        content:"";
        display:block;
        width:10px;
        height:0;
        border-top:1px solid;
        /*margin-top:-1px;*/
        position:absolute;
        top:1em;
        left:0
    }
    .tree ul li:last-child:before {
        background:#FFF;
        height:auto;
        top:1em;
        bottom:0
    }
    .indicator {
        margin-right:5px;
    }
    .tree li a {
        text-decoration: none;
        color:#369;
    }
    .tree li button, .tree li button:active, .tree li button:focus {
        text-decoration: none;
        color:#369;
        border:none;
        background:transparent;
        margin:0px 0px 0px 0px;
        padding:0px 0px 0px 0px;
        outline: 0;
    }

    .sidebar-nav{
        height:calc(100% - 24px);
        overflow-y:scroll;
        border:1px solid;
    }
</style>


